#!/usr/bin/env python3
"""Скрипт для получения поставщиков из Bitrix24 и сохранения в Excel"""

import pandas as pd
from core import query_to_bitrix, get_all_pages

# Типы компаний, которые нужно получить (учитываем опечатки в Bitrix)
TARGET_TYPES = [
    "Поставщик",
    "Поставщик - Резерв (предоплата)",
    "Постащик - Резерв (предоплата)",  # опечатка в Bitrix
    "Монтажник на месте"
]

# Поле региона компании
REGION_FIELD = "UF_CRM_1756212422"

# Маппинг регионов на их главные города
REGION_TO_CITY = {
    "Москва Город": "Москва",
    "Санкт-Петербург Город": "Санкт-Петербург",
    "Севастополь Город": "Севастополь",
    # Области
    "Амурская Область": "Благовещенск",
    "Архангельская Область": "Архангельск",
    "Астраханская Область": "Астрахань",
    "Белгородская Область": "Белгород",
    "Брянская Область": "Брянск",
    "Владимирская Область": "Владимир",
    "Волгоградская Область": "Волгоград",
    "Вологодская Область": "Вологда",
    "Воронежская Область": "Воронеж",
    "Ивановская Область": "Иваново",
    "Иркутская Область": "Иркутск",
    "Калининградская Область": "Калининград",
    "Калужская Область": "Калуга",
    "Кемеровская Область": "Кемерово",
    "Кировская Область": "Киров",
    "Костромская Область": "Кострома",
    "Курганская Область": "Курган",
    "Курская Область": "Курск",
    "Ленинградская Область": "Санкт-Петербург",
    "Липецкая Область": "Липецк",
    "Магаданская Область": "Магадан",
    "Московская Область": "Москва",
    "Мурманская Область": "Мурманск",
    "Нижегородская Область": "Нижний Новгород",
    "Новгородская Область": "Великий Новгород",
    "Новосибирская Область": "Новосибирск",
    "Омская Область": "Омск",
    "Оренбургская Область": "Оренбург",
    "Орловская Область": "Орёл",
    "Пензенская Область": "Пенза",
    "Псковская Область": "Псков",
    "Ростовская Область": "Ростов-на-Дону",
    "Рязанская Область": "Рязань",
    "Самарская Область": "Самара",
    "Саратовская Область": "Саратов",
    "Сахалинская Область": "Южно-Сахалинск",
    "Свердловская Область": "Екатеринбург",
    "Смоленская Область": "Смоленск",
    "Тамбовская Область": "Тамбов",
    "Тверская Область": "Тверь",
    "Томская Область": "Томск",
    "Тульская Область": "Тула",
    "Тюменская Область": "Тюмень",
    "Ульяновская Область": "Ульяновск",
    "Челябинская Область": "Челябинск",
    "Ярославская Область": "Ярославль",
    # Республики
    "Адыгея Республика": "Майкоп",
    "Алтай Республика": "Горно-Алтайск",
    "Башкортостан Республика": "Уфа",
    "Бурятия Республика": "Улан-Удэ",
    "Дагестан Республика": "Махачкала",
    "Ингушетия Республика": "Магас",
    "Кабардино-Балкарская Республика": "Нальчик",
    "Калмыкия Республика": "Элиста",
    "Карачаево-Черкесская Республика": "Черкесск",
    "Карелия Республика": "Петрозаводск",
    "Коми Республика": "Сыктывкар",
    "Крым Республика": "Симферополь",
    "Марий Эл Республика": "Йошкар-Ола",
    "Мордовия Республика": "Саранск",
    "Саха /Якутия/ Республика": "Якутск",
    "Северная Осетия-Алания Республика": "Владикавказ",
    "Татарстан Республика": "Казань",
    "Тыва Республика": "Кызыл",
    "Удмуртская Республика": "Ижевск",
    "Хакасия Республика": "Абакан",
    "Чеченская Республика": "Грозный",
    "Чувашская Республика": "Чебоксары",
    # Края
    "Алтайский Край": "Барнаул",
    "Забайкальский Край": "Чита",
    "Камчатский Край": "Петропавловск-Камчатский",
    "Краснодарский Край": "Краснодар",
    "Красноярский Край": "Красноярск",
    "Пермский Край": "Пермь",
    "Приморский Край": "Владивосток",
    "Ставропольский Край": "Ставрополь",
    "Хабаровский Край": "Хабаровск",
    # Автономные округа и область
    "Ханты-Мансийский Автономный округ - Югра": "Ханты-Мансийск",
    "Чукотский Автономный округ": "Анадырь",
    "Ямало-Ненецкий Автономный округ": "Салехард",
    "Еврейская Автономная область": "Биробиджан",
    "Ненецкий Автономный округ": "Нарьян-Мар",
}


def get_company_type_statuses():
    """Получаем список статусов типов компаний"""
    params = {"filter": {"ENTITY_ID": "COMPANY_TYPE"}}
    statuses = query_to_bitrix("get_status_list", **params)
    if statuses:
        print("Типы компаний:")
        for status in statuses:
            print(f"  ID: {status.get('STATUS_ID')}, Name: {status.get('NAME')}")
        return statuses
    return []


def get_region_values():
    """Получаем значения поля региона"""
    fields = query_to_bitrix("get_company_fields")
    if fields and REGION_FIELD in fields:
        field_info = fields[REGION_FIELD]
        items = field_info.get("items", [])
        if items:
            region_map = {}
            for item in items:
                region_map[item.get("ID")] = item.get("VALUE")
            print(f"\nНайдено {len(region_map)} регионов")
            return region_map
    return {}


def get_target_type_ids(statuses):
    """Получаем ID нужных типов компаний"""
    type_ids = []
    for status in statuses:
        if status.get("NAME") in TARGET_TYPES:
            type_ids.append(status.get("STATUS_ID"))
            print(f"  -> Выбран: {status.get('NAME')} (ID: {status.get('STATUS_ID')})")
    return type_ids


def decode_region(region_value, region_map):
    """Преобразует ID региона в название главного города"""
    if not region_value:
        return ""

    if isinstance(region_value, list):
        # Если это список ID, берем первый
        if region_value:
            first_id = str(region_value[0])
            region_name = region_map.get(first_id, first_id)
        else:
            return ""
    else:
        region_name = region_map.get(str(region_value), str(region_value))

    # Преобразуем название региона в главный город
    return REGION_TO_CITY.get(region_name, region_name)


def main():
    print("Получаем типы компаний...")
    statuses = get_company_type_statuses()

    if not statuses:
        print("Не удалось получить типы компаний")
        return

    print("\nПолучаем значения поля регионов...")
    region_map = get_region_values()

    print("\nИщем ID нужных типов...")
    target_ids = get_target_type_ids(statuses)

    if not target_ids:
        print("Не найдены нужные типы компаний")
        return

    print(f"\nПолучаем компании с типами: {target_ids}")

    # Получаем все компании с фильтром по типу
    all_companies = []
    for type_id in target_ids:
        params = {
            "filter": {"COMPANY_TYPE": type_id},
            "select": ["ID", "TITLE", REGION_FIELD]
        }
        companies = get_all_pages("get_all_companies", params)
        if companies:
            all_companies.extend(companies)
            print(f"  Тип {type_id}: найдено {len(companies)} компаний")

    print(f"\nВсего найдено: {len(all_companies)} компаний")

    if not all_companies:
        print("Компании не найдены")
        return

    # Формируем данные для Excel
    data = []
    for company in all_companies:
        region_value = company.get(REGION_FIELD, "")
        city = decode_region(region_value, region_map)

        data.append({
            "название компании": company.get("TITLE", ""),
            "Город головного офиса": city
        })

    # Создаем DataFrame и сохраняем в Excel
    df = pd.DataFrame(data)
    output_file = "suppliers.xlsx"
    df.to_excel(output_file, index=False)
    print(f"\nДанные сохранены в файл: {output_file}")
    print(df)


if __name__ == "__main__":
    main()
